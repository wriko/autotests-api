# –ò–º—è –≤–∞—à–µ–≥–æ workflow, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ GitHub Actions
name: API tests

# –£–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –¥–∞–Ω–Ω—ã–π workflow
on:
  push:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞—Ç—å workflow, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω –∫–æ–º–º–∏—Ç –≤ –≤–µ—Ç–∫—É main
  pull_request:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞—Ç—å workflow, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω pull request –≤ –≤–µ—Ç–∫—É main

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Å–µ —à–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤ —Ä–∞–º–∫–∞—Ö —Ä–∞–±–æ—Ç—ã —Å —Ç–µ—Å—Ç–∞–º–∏
jobs:
  run-tests:
    runs-on: ubuntu-latest  # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Ubuntu

    steps:
      # 1. –®–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ –º–∞—à–∏–Ω—É GitHub Actions
      - name: Check out repository
        uses: actions/checkout@v4  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GitHub Action (checkout@v4) –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

      # 2. –®–∞–≥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Python –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ GitHub Actions
      - name: Set up Python
        uses: actions/setup-python@v5  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GitHub Action (setup-python@v5) –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Python
        with:
          python-version: '3.12'  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é Python 3.12 (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é –≤–µ—Ä—Å–∏—é)

      # 3. –®–∞–≥ –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å —Ç–µ—Å—Ç–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º –≤ —Ä–∞–±–æ—á—É—é —Å—Ä–µ–¥—É
      - name: Clone test server repository
        run: git clone https://github.com/Nikita-Filonov/qa-automation-engineer-api-course.git

      # 4. –®–∞–≥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
      - name: Install test server dependencies
        run: pip install -r qa-automation-engineer-api-course/requirements.txt # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ requirements.txt —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (—É–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—å –∫ —Ñ–∞–π–ª—É —á–µ—Ä–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞)

      # 5. –®–∞–≥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      - name: Start a test server
        env: # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ —Ñ–∞–π–ª–∞ .env. –ù–æ –¥–ª—è —ç—Ç–æ–≥–æ –Ω–∞–¥–æ –≤ —Ñ–∞–π–ª–µ config.py –≤ –∫–ª–∞—Å—Å–µ Settings –¥–æ–±–∞–≤–∏—Ç—å extra="allow",
          APP_HOST: "http://localhost:8000"  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–¥—Ä–µ—Å —Ö–æ—Å—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
          DATABASE_URL: "sqlite+aiosqlite:///./local.db" # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          JWT_ALGORITHM: "HS256" # –ê–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è JWT —Ç–æ–∫–µ–Ω–æ–≤
          JWT_SECRET_KEY: "qa-automation-engineer-api-course-secret-key" # –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è JWT
          JWT_ACCESS_TOKEN_EXPIRE: 1800 # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ access token (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
          JWT_REFRESH_TOKEN_EXPIRE: 5184000 # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ refresh token (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
        run: uvicorn main:app --host 0.0.0.0 --port 8000 --app-dir ./qa-automation-engineer-api-course & # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (&) —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

      # 6. –®–∞–≥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip  # –û–±–Ω–æ–≤–ª—è–µ–º pip –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
          pip install -r requirements.txt  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ requirements.txt

      # 7. –®–∞–≥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º pytest –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ Allure
      - name: Run API tests with pytest and generate Allure results
        run: |
          pytest -m regression --alluredir=allure-results --numprocesses 2  # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ "regression" –≤ 2 –ø–æ—Ç–æ–∫–∞, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è Allure



      # 8. –®–∞–≥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ Allure, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      - name: Get Allure history
        uses: actions/checkout@v4  # –û–ø—è—Ç—å –∫–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ—Ç—á—ë—Ç–æ–≤
        if: always()  # –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Å–ø–µ—Ö–∞ –∏–ª–∏ –Ω–µ—É–¥–∞—á–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
        continue-on-error: true  # –ï—Å–ª–∏ –∑–¥–µ—Å—å –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –æ—à–∏–±–∫–∞, workflow –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        with:
          ref: gh-pages  # –£–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ç–∫—É gh-pages –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤
          path: gh-pages  # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤



      # 9. –®–∞–≥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç—á—ë—Ç–∞ Allure
      - name: Generates Allure Report with history
        uses: simple-elf/allure-report-action@v1.12  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ GitHub Marketplace –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Allure –æ—Ç—á—ë—Ç–∞
        if: always()  # –≠—Ç–æ—Ç —à–∞–≥ —Ç–æ–∂–µ –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
        with:
          allure_results: allure-results  # –£–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤
          allure_history: allure-history  # –£–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ Allure

      # 9.1. –£–¥–∞–ª—è–µ–º CNAME, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
      - name: Remove CNAME file if exists
        run: rm -f allure-history/CNAME

      # 9.2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ allure-history –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è
      - name: List files in allure-history
        run: ls -la allure-history


      # 10.  –®–∞–≥ –¥–ª—è –¥–µ–ø–ª–æ—è –æ—Ç—á—ë—Ç–∞ Allure –Ω–∞ GitHub Pages, —á—Ç–æ–±—ã –µ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
      - name: Deploy report to  Github Pages
        if: always()  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Å–ø–µ—Ö–∞ –¥—Ä—É–≥–∏—Ö —à–∞–≥–æ–≤
        uses: peaceiris/actions-gh-pages@v4  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GitHub Action –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞ –Ω–∞ GitHub Pages
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}  # –¢–æ–∫–µ–Ω –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ GitHub
          publish_branch: gh-pages  # –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ—Ç—á—ë—Ç –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ –≤–µ—Ç–∫–µ gh-pages
          publish_dir: allure-history  # –£–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –Ω–∞ GitHub Pages


      # 11. –®–∞–≥ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ Allure-–æ—Ç—á—ë—Ç
      - name: Show Allure Report link
        if: always()
        run:
          echo "üëâ Allure Report: https://wriko.github.io/autotests-api/"